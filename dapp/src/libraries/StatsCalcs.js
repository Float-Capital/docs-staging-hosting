// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Ethers = require("../ethereum/Ethers.js");
var CONSTANTS = require("../CONSTANTS.js");
var Belt_Array = require("rescript/lib/js/belt_Array.js");
var Belt_SortArray = require("rescript/lib/js/belt_SortArray.js");
var MarketCalculationHelpers = require("./MarketCalculationHelpers.js");

function trendingStakes(syntheticMarkets, apy) {
  return Belt_Array.slice(Belt_SortArray.stableSortBy(Belt_Array.reduce(syntheticMarkets, [], (function (previous, param) {
                        var match = param.latestSystemState;
                        var totalLockedShort = match.totalLockedShort;
                        var totalLockedLong = match.totalLockedLong;
                        var currentTimestamp = match.timestamp;
                        var timestampCreated = param.timestampCreated;
                        var marketName = param.name;
                        var longApy = MarketCalculationHelpers.calculateLendingProviderAPYForSide(apy, Number(Ethers.Utils.formatEther(totalLockedLong)), Number(Ethers.Utils.formatEther(totalLockedShort)), "long");
                        var shortApy = MarketCalculationHelpers.calculateLendingProviderAPYForSide(apy, Number(Ethers.Utils.formatEther(totalLockedLong)), Number(Ethers.Utils.formatEther(totalLockedShort)), "short");
                        var longFloatApy = MarketCalculationHelpers.calculateFloatAPY(totalLockedLong, totalLockedShort, CONSTANTS.kperiodHardcode, CONSTANTS.kmultiplierHardcode, timestampCreated, currentTimestamp, CONSTANTS.equilibriumOffsetHardcode, CONSTANTS.balanceIncentiveExponentHardcode, "long");
                        var shortFloatApy = MarketCalculationHelpers.calculateFloatAPY(totalLockedLong, totalLockedShort, CONSTANTS.kperiodHardcode, CONSTANTS.kmultiplierHardcode, timestampCreated, currentTimestamp, CONSTANTS.equilibriumOffsetHardcode, CONSTANTS.balanceIncentiveExponentHardcode, "short");
                        return Belt_Array.concat(previous, [
                                    {
                                      marketName: marketName,
                                      isLong: true,
                                      apy: longApy,
                                      floatApy: Number(Ethers.Utils.formatEther(longFloatApy))
                                    },
                                    {
                                      marketName: marketName,
                                      isLong: false,
                                      apy: shortApy,
                                      floatApy: Number(Ethers.Utils.formatEther(shortFloatApy))
                                    }
                                  ]);
                      })), (function (token1, token2) {
                    var match = token1.apy + token1.floatApy;
                    var match$1 = token2.apy + token2.floatApy;
                    if (match < match$1) {
                      return 1;
                    } else if (match$1 > match) {
                      return -1;
                    } else {
                      return 0;
                    }
                  })), 0, 3);
}

function tokenSupplyToTokenValue(tokenPrice, tokenSupply) {
  return tokenSupply.mul(tokenPrice).div(CONSTANTS.tenToThe18);
}

function getTotalSynthValue(totalValueLocked, totalValueStaked) {
  return totalValueLocked.sub(totalValueStaked);
}

function getTotalValueLockedAndTotalStaked(syntheticMarkets) {
  return Belt_Array.reduce(syntheticMarkets, {
              totalValueLocked: CONSTANTS.zeroBN,
              totalValueStaked: CONSTANTS.zeroBN
            }, (function (previous, param) {
                var match = param.latestSystemState;
                return {
                        totalValueLocked: previous.totalValueLocked.add(match.totalValueLocked),
                        totalValueStaked: previous.totalValueStaked.add(tokenSupplyToTokenValue(match.longTokenPrice.price.price, param.syntheticLong.totalStaked)).add(tokenSupplyToTokenValue(match.shortTokenPrice.price.price, param.syntheticShort.totalStaked))
                      };
              }));
}

exports.trendingStakes = trendingStakes;
exports.tokenSupplyToTokenValue = tokenSupplyToTokenValue;
exports.getTotalSynthValue = getTotalSynthValue;
exports.getTotalValueLockedAndTotalStaked = getTotalValueLockedAndTotalStaked;
/* Ethers Not a pure module */
