// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var LetOps = require("./LetOps.js");
var Helpers = require("./Helpers.js");
var Contract = require("./Contract.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");

function mintAndStake(marketIndex, amount, token, user, longShort, isLong) {
  return LetOps.Await.let_(Contract.PaymentToken.mintAndApprove(token, user, amount, longShort.address), (function (param) {
                var contract = longShort.connect(user);
                if (isLong) {
                  return contract.mintLongAndStake(marketIndex, amount);
                } else {
                  return contract.mintShortAndStake(marketIndex, amount);
                }
              }));
}

function stakeRandomlyInMarkets(marketsToStakeIn, userToStakeWith, longShort) {
  return Belt_Array.reduce(marketsToStakeIn, Promise.resolve([
                  [],
                  []
                ]), (function (currentValues, param) {
                var marketIndex = param.marketIndex;
                var shortSynth = param.shortSynth;
                var longSynth = param.longSynth;
                var paymentToken = param.paymentToken;
                return LetOps.AwaitThen.let_(currentValues, (function (param) {
                              var marketsUserHasStakedIn = param[1];
                              var synthsUserHasStakedIn = param[0];
                              var mintStake = function (param) {
                                return function (param$1) {
                                  return mintAndStake(marketIndex, param, paymentToken, userToStakeWith, longShort, param$1);
                                };
                              };
                              var amount = Helpers.randomMintLongShort(undefined);
                              var tmp;
                              switch (amount.TAG | 0) {
                                case /* Long */0 :
                                    tmp = LetOps.Await.let_(mintStake(amount._0)(true), (function (param) {
                                            return Belt_Array.concat(synthsUserHasStakedIn, [longSynth]);
                                          }));
                                    break;
                                case /* Short */1 :
                                    tmp = LetOps.Await.let_(mintStake(amount._0)(false), (function (param) {
                                            return Belt_Array.concat(synthsUserHasStakedIn, [shortSynth]);
                                          }));
                                    break;
                                case /* Both */2 :
                                    var shortAmount = amount._1;
                                    tmp = LetOps.AwaitThen.let_(mintStake(amount._0)(true), (function (param) {
                                            return LetOps.Await.let_(mintStake(shortAmount)(false), (function (param) {
                                                          return Belt_Array.concat(synthsUserHasStakedIn, [
                                                                      shortSynth,
                                                                      shortSynth
                                                                    ]);
                                                        }));
                                          }));
                                    break;
                                
                              }
                              return LetOps.Await.let_(tmp, (function (newSynthsUserHasStakedIn) {
                                            return [
                                                    newSynthsUserHasStakedIn,
                                                    Belt_Array.concat(marketsUserHasStakedIn, [marketIndex])
                                                  ];
                                          }));
                            }));
              }));
}

exports.mintAndStake = mintAndStake;
exports.stakeRandomlyInMarkets = stakeRandomlyInMarkets;
/* No side effect */
